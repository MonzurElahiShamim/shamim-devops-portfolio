# CI/CD Pipeline for DevOps Portfolio
# 
# To enable code scanning results upload to GitHub Security tab:
# 1. Go to repository Settings > Code security and analysis
# 2. Enable "Code scanning" under "Code security"
# 3. The workflow will automatically upload Trivy results to Security tab
#
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write          # Required for GitHub Pages deployment
  pages: write            # Required for GitHub Pages
  id-token: write         # Required for GitHub Pages with OIDC
  security-events: write  # Required for security scanning
  actions: read           # Required for workflow information

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Lint code
      run: npm run lint
      
    - name: Type check
      run: npm run build
      
    - name: Run tests (when added)
      run: echo "No tests configured yet"
      # run: bun test
      
  security:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Run Trivy vulnerability scanner (table format)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always() && github.event_name != 'pull_request'
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true
        
    - name: Upload scan results as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: trivy-results
        path: trivy-results.sarif

  build:
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true  # This loads the image into local Docker daemon
        tags: portfolio:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Test Docker image
      run: |
        # Start container in background
        docker run -d --name test-container -p 8080:80 portfolio:latest
        
        # Wait for container to be ready
        echo "Waiting for container to start..."
        sleep 15
        
        # Check if container is running
        if ! docker ps | grep -q test-container; then
          echo "Container failed to start. Logs:"
          docker logs test-container
          exit 1
        fi
        
        # Test if the application is responding
        echo "Testing application response..."
        max_attempts=10
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if curl -f http://localhost:8080/ > /dev/null 2>&1; then
            echo "‚úÖ Application is responding!"
            break
          elif [ $attempt -eq $max_attempts ]; then
            echo "‚ùå Application not responding after $max_attempts attempts"
            echo "Container logs:"
            docker logs test-container
            docker stop test-container
            exit 1
          else
            echo "Attempt $attempt/$max_attempts: Application not ready yet, waiting..."
            sleep 3
            attempt=$((attempt + 1))
          fi
        done
        
        # Cleanup
        docker stop test-container
        docker rm test-container

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
      
    # Optional: GitHub Pages for demo/backup
    - name: Deploy to GitHub Pages (Demo)
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy demo to GitHub Pages'
      continue-on-error: true
        
    # EC2 Deployment Instructions
    - name: EC2 Deployment Guide
      run: |
        echo "üöÄ EC2 Deployment Ready!"
        echo ""
        echo "üìã Your EC2 deployment workflow:"
        echo ""
        echo "1Ô∏è‚É£  Setup AWS Infrastructure:"
        echo "   ./scripts/create-aws-infrastructure.sh"
        echo ""
        echo "2Ô∏è‚É£  Connect to EC2:"
        echo "   ssh -i portfolio-key.pem ubuntu@your-ec2-ip"
        echo ""
        echo "3Ô∏è‚É£  Clone and Setup:"
        echo "   git clone https://github.com/MonzurElahiShamim/shamim-devops-portfolio.git"
        echo "   cd shamim-devops-portfolio"
        echo "   ./scripts/setup-ec2.sh"
        echo ""
        echo "4Ô∏è‚É£  Deploy Application:"
        echo "   ./scripts/deploy-ec2.sh your-domain.com"
        echo ""
        echo "5Ô∏è‚É£  Monitor Deployment:"
        echo "   ./scripts/monitor-portfolio.sh"
        echo ""
        echo "üìÅ Available automation scripts:"
        echo "‚úÖ scripts/create-aws-infrastructure.sh - AWS resource creation"
        echo "‚úÖ scripts/setup-ec2.sh - EC2 environment setup"  
        echo "‚úÖ scripts/deploy-ec2.sh - Application deployment"
        echo "‚úÖ scripts/monitor-portfolio.sh - Health monitoring"
        echo ""
        echo "üìñ Comprehensive documentation:"
        echo "‚úÖ docs/EC2_DEPLOYMENT.md - Complete deployment guide"
        echo "‚úÖ docs/DEPLOYMENT_CHECKLIST.md - Step-by-step checklist"
        echo "‚úÖ docs/GITHUB_SETUP.md - Repository configuration"
        echo ""
        echo "üéØ Build Status:"
        echo "‚úÖ Docker image built: portfolio:latest"
        echo "‚úÖ Application tested and verified"
        echo "‚úÖ Ready for EC2 deployment"
        
    # Build Summary
    - name: Deployment Summary
      run: |
        echo "üéâ CI/CD Pipeline Completed Successfully!"
        echo ""
        echo "üìä Pipeline Results:"
        echo "‚úÖ Code linting and type checking passed"
        echo "‚úÖ Security scanning completed (Trivy)"
        echo "‚úÖ Docker image built and tested"
        echo "‚úÖ Application build verified"
        echo ""
        echo "üåê Access Options:"
        echo "üì± GitHub Pages Demo: https://monzurs.me/shamim-devops-portfolio"
        echo "‚òÅÔ∏è  EC2 Production: Ready for deployment"
        echo ""
        echo "üîß Next Steps:"
        echo "1. Follow EC2 deployment guide above"
        echo "2. Configure your domain DNS"
        echo "3. Setup SSL with Let's Encrypt"
        echo "4. Monitor with provided scripts"
